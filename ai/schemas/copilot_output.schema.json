{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "title": "CSA Copilot Output",
  "description": "Unified AI layer response for the Azure Landing Zone Assessor.",
  "type": "object",
  "required": ["meta", "executive", "remediation_items", "transformation_roadmap"],
  "properties": {
    "meta": {
      "type": "object",
      "required": ["generated_at", "assessment_run_id", "tenant_id"],
      "properties": {
        "generated_at": { "type": "string", "format": "date-time" },
        "assessment_run_id": { "type": "string" },
        "tenant_id": { "type": "string" }
      }
    },
    "executive": {
      "type": "object",
      "required": ["summary", "top_business_risks", "investment_priorities", "expected_outcomes_90_days"],
      "properties": {
        "summary": { "type": "string" },
        "top_business_risks": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["title", "business_impact", "technical_cause"],
            "properties": {
              "title": { "type": "string" },
              "business_impact": { "type": "string" },
              "technical_cause": { "type": "string" },
              "severity": { "type": "string", "enum": ["Critical", "High", "Medium"] },
              "affected_controls": { "type": "array", "items": { "type": "string" } }
            }
          }
        },
        "investment_priorities": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "priority": { "type": "integer" },
              "initiative": { "type": "string" },
              "estimated_effort": { "type": "string" },
              "business_value": { "type": "string" }
            }
          }
        },
        "expected_outcomes_90_days": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "enterprise_scale_readiness": {
      "type": "object",
      "required": ["ready_for_enterprise_scale", "max_supported_subscriptions_current_state", "blockers"],
      "properties": {
        "ready_for_enterprise_scale": { "type": "boolean" },
        "max_supported_subscriptions_current_state": { "type": "integer" },
        "readiness_score": { "type": "integer", "minimum": 0, "maximum": 100 },
        "blockers": {
          "type": "array",
          "items": {
            "type": "object",
            "properties": {
              "category": { "type": "string" },
              "description": { "type": "string" },
              "severity": { "type": "string" },
              "resolving_checklist_ids": {
                "type": "array",
                "items": { "type": "string", "pattern": "^[A-Z]\\d{2}\\.\\d{2}$" }
              }
            }
          }
        },
        "minimum_items_required": {
          "type": "array",
          "items": { "type": "string" }
        },
        "scaling_recommendations": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "transformation_roadmap": {
      "type": "object",
      "properties": {
        "roadmap_30_60_90": {
          "type": "object",
          "properties": {
            "30_days": { "type": "array" },
            "60_days": { "type": "array" },
            "90_days": { "type": "array" }
          }
        },
        "dependency_graph": { "type": "array" },
        "critical_path": { "type": "array", "items": { "type": "string" } },
        "parallel_execution_groups": { "type": "array" },
        "maturity_trajectory": {
          "type": "object",
          "properties": {
            "current_maturity_percent": { "type": "number" },
            "projected_30_day_percent": { "type": "number" },
            "projected_60_day_percent": { "type": "number" },
            "projected_90_day_percent": { "type": "number" },
            "assumptions": { "type": "array", "items": { "type": "string" } }
          }
        }
      }
    },
    "remediation_items": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["checklist_id", "title", "priority", "blast_radius", "caf_discipline"],
        "properties": {
          "checklist_id": { "type": "string", "pattern": "^[A-Z]\\d{2}\\.\\d{2}$" },
          "title": { "type": "string" },
          "priority": { "type": "integer" },
          "blast_radius": { "type": "string", "enum": ["High", "Medium", "Low"] },
          "caf_discipline": { "type": "string" },
          "why_it_matters": { "type": "string" },
          "success_criteria": { "type": "string" },
          "dependencies": { "type": "array", "items": { "type": "string" } },
          "controls": { "type": "array", "items": { "type": "string" } },
          "owner_role": { "type": "string" },
          "delivery_model": {
            "type": "object",
            "properties": {
              "estimated_duration": { "type": "string" },
              "team": { "type": "array", "items": { "type": "string" } },
              "change_scope": { "type": "string", "enum": ["Tenant", "ManagementGroup", "Subscription"] }
            }
          },
          "learn_references": {
            "type": "array",
            "items": {
              "type": "object",
              "properties": {
                "title": { "type": "string" },
                "url": { "type": "string", "format": "uri" }
              }
            }
          }
        }
      }
    },
    "implementation_backlog": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["checklist_id", "implementation"],
        "properties": {
          "checklist_id": { "type": "string" },
          "implementation": {
            "type": "object",
            "properties": {
              "bicep_modules": { "type": "array" },
              "policy_assignments": { "type": "array" },
              "rbac_roles": { "type": "array" },
              "pipelines": { "type": "array" },
              "validation_queries": { "type": "array" }
            }
          }
        }
      }
    },
    "smart_questions": {
      "type": "array",
      "items": {
        "type": "object",
        "required": ["question", "type", "resolves_controls"],
        "properties": {
          "question": { "type": "string" },
          "type": { "type": "string", "enum": ["yes_no", "selection", "maturity_scale"] },
          "resolves_controls": { "type": "array", "items": { "type": "string" } },
          "impact_if_yes": { "type": "string" },
          "impact_if_no": { "type": "string" },
          "follow_up_recommendation": { "type": "string" }
        }
      }
    },
    "progress_analysis": {
      "type": "object",
      "properties": {
        "velocity": { "type": "string", "enum": ["stalled", "progressing", "regressing"] },
        "maturity_trend": { "type": "string" },
        "recommended_next_item": { "type": "string" }
      }
    },

    "evidence_refs": {
      "description": "Reusable evidence_refs schema — every derived object must carry this.",
      "type": "object",
      "required": ["controls", "signals"],
      "properties": {
        "controls": { "type": "array", "items": { "type": "string" }, "description": "Control IDs that ground this conclusion." },
        "risks": { "type": "array", "items": { "type": "string" }, "description": "Risk titles or IDs." },
        "blockers": { "type": "array", "items": { "type": "string" }, "description": "Blocker categories or descriptions." },
        "signals": { "type": "array", "items": { "type": "string" }, "description": "Signal keys (signal:key format)." },
        "mcp_queries": { "type": "array", "items": { "type": "string" }, "description": "MCP queries used for grounding." }
      }
    },

    "decision_impact_model": {
      "type": "object",
      "description": "Per-item 'what breaks if not implemented' — deterministic joins only.",
      "required": ["items"],
      "properties": {
        "items": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["checklist_id", "if_not_implemented", "confidence", "evidence_refs", "assumptions"],
            "properties": {
              "checklist_id": { "type": "string" },
              "if_not_implemented": {
                "type": "object",
                "required": ["enterprise_scale_blocked", "critical_risks_remaining", "fail_controls_remaining", "blocked_initiatives", "maturity_ceiling_notes"],
                "properties": {
                  "enterprise_scale_blocked": { "type": "boolean" },
                  "critical_risks_remaining": { "type": "integer" },
                  "fail_controls_remaining": { "type": "integer" },
                  "blocked_items": { "type": "array", "items": { "type": "string" } },
                  "maturity_ceiling_notes": { "type": "string" }
                }
              },
              "confidence": {
                "type": "object",
                "required": ["value", "basis", "label"],
                "properties": {
                  "value": { "type": "number", "minimum": 0, "maximum": 1 },
                  "basis": { "type": "string" },
                  "label": { "type": "string", "enum": ["None", "Low", "Medium", "High"] }
                }
              },
              "evidence_refs": { "$ref": "#/properties/evidence_refs" },
              "assumptions": { "type": "array", "items": { "type": "string" } }
            }
          }
        }
      }
    },

    "scaling_simulation": {
      "type": "object",
      "description": "Deterministic scaling projection for multi-subscription scenarios. Every impact driven by a rule_id.",
      "required": ["scenarios"],
      "properties": {
        "scenarios": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["scenario", "current_subscriptions", "target_subscriptions", "derived_impacts"],
            "properties": {
              "scenario": { "type": "string" },
              "current_subscriptions": { "type": "integer" },
              "target_subscriptions": { "type": "integer" },
              "derived_impacts": {
                "type": "array",
                "items": {
                  "type": "object",
                  "required": ["impact_statement", "rule_id", "evidence_refs", "assumptions"],
                  "properties": {
                    "impact_statement": { "type": "string" },
                    "rule_id": { "type": "string", "pattern": "^RULE-[A-Z]+-\\d{3}$" },
                    "evidence_refs": { "$ref": "#/properties/evidence_refs" },
                    "assumptions": { "type": "array", "items": { "type": "string" } }
                  }
                }
              }
            }
          }
        }
      }
    },

    "drift_model": {
      "type": "object",
      "description": "Deterministic drift likelihood from signal gaps. No freeform inference.",
      "required": ["mode", "drift_likelihood", "drift_score", "active_factors", "confidence", "evidence_refs", "assumptions"],
      "properties": {
        "mode": { "type": "string", "enum": ["static", "activity_log_backed"] },
        "drift_likelihood": { "type": "string", "enum": ["Low", "Medium", "High"] },
        "drift_score": { "type": "number", "minimum": 0, "maximum": 1 },
        "active_factors": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["factor", "description", "weight"],
            "properties": {
              "factor": { "type": "string" },
              "description": { "type": "string" },
              "weight": { "type": "number" }
            }
          }
        },
        "all_factors_evaluated": { "type": "integer" },
        "confidence": {
          "type": "object",
          "required": ["value", "basis", "label"],
          "properties": {
            "value": { "type": "number", "minimum": 0, "maximum": 1 },
            "basis": { "type": "string" },
            "label": { "type": "string", "enum": ["None", "Low", "Medium", "High"] }
          }
        },
        "evidence_refs": { "$ref": "#/properties/evidence_refs" },
        "assumptions": { "type": "array", "items": { "type": "string" } },
        "activity_log_insights": { "type": "array", "items": { "type": "string" } }
      }
    },

    "cost_simulation": {
      "type": "object",
      "description": "Category-based cost drivers. No dollar amounts unless mode=tool_backed.",
      "required": ["mode", "drivers"],
      "properties": {
        "mode": { "type": "string", "enum": ["category_only", "tool_backed"] },
        "drivers": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["checklist_id", "resources_introduced", "billing_meters", "estimated_monthly_category", "evidence_refs", "assumptions"],
            "properties": {
              "checklist_id": { "type": "string" },
              "resources_introduced": { "type": "array", "items": { "type": "string" } },
              "billing_meters": { "type": "array", "items": { "type": "string" } },
              "estimated_monthly_category": { "type": "string", "enum": ["Low", "Medium", "High"] },
              "evidence_refs": { "$ref": "#/properties/evidence_refs" },
              "assumptions": { "type": "array", "items": { "type": "string" } }
            }
          }
        }
      }
    },

    "governance_intelligence": {
      "type": "object",
      "description": "Layer 3b — AI-synthesised governance intelligence from all deterministic decision engine outputs. Cross-cutting strategic insights that span individual models.",
      "required": ["governance_posture", "policy_as_code_readiness", "operating_model_alignment", "compliance_synthesis", "strategic_governance_recommendations", "cross_cutting_insights"],
      "properties": {
        "governance_posture": {
          "type": "object",
          "required": ["current_state", "target_state", "governance_debt_rating"],
          "properties": {
            "current_state": { "type": "string" },
            "target_state": { "type": "string" },
            "governance_debt_rating": { "type": "string", "enum": ["Critical", "High", "Medium", "Low"] }
          }
        },
        "policy_as_code_readiness": {
          "type": "object",
          "required": ["current_coverage_assessment", "recommended_policy_initiatives", "automation_gaps", "estimated_policy_coverage_post_90_days"],
          "properties": {
            "current_coverage_assessment": { "type": "string" },
            "recommended_policy_initiatives": { "type": "array", "items": { "type": "string" } },
            "automation_gaps": { "type": "array", "items": { "type": "string" } },
            "estimated_policy_coverage_post_90_days": { "type": "string" }
          }
        },
        "operating_model_alignment": {
          "type": "object",
          "required": ["platform_team_recommendations", "operating_model_maturity", "recommended_evolution"],
          "properties": {
            "platform_team_recommendations": {
              "type": "array",
              "items": {
                "type": "object",
                "required": ["role", "current_gap", "post_remediation_capability", "critical_items"],
                "properties": {
                  "role": { "type": "string" },
                  "current_gap": { "type": "string" },
                  "post_remediation_capability": { "type": "string" },
                  "critical_items": { "type": "array", "items": { "type": "string" } }
                }
              }
            },
            "operating_model_maturity": { "type": "string", "enum": ["Centralized", "Federated", "Hybrid"] },
            "recommended_evolution": { "type": "string" }
          }
        },
        "compliance_synthesis": {
          "type": "object",
          "required": ["regulatory_readiness_gaps", "audit_trail_assessment", "guardrail_coverage"],
          "properties": {
            "regulatory_readiness_gaps": { "type": "array", "items": { "type": "string" } },
            "audit_trail_assessment": { "type": "string" },
            "guardrail_coverage": { "type": "string" }
          }
        },
        "strategic_governance_recommendations": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["recommendation", "rationale", "prerequisite_items", "expected_governance_outcome", "priority"],
            "properties": {
              "recommendation": { "type": "string" },
              "rationale": { "type": "string" },
              "prerequisite_items": { "type": "array", "items": { "type": "string" } },
              "expected_governance_outcome": { "type": "string" },
              "priority": { "type": "string", "enum": ["Immediate", "Short-term", "Medium-term"] }
            }
          }
        },
        "cross_cutting_insights": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["insight", "evidence", "implication"],
            "properties": {
              "insight": { "type": "string" },
              "evidence": { "type": "string" },
              "implication": { "type": "string" }
            }
          }
        }
      }
    }
  }
}
